package miniprojectServer;

import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.OutputStream;

import java.net.ServerSocket;
import java.net.Socket;


public class ServerControl extends Server {
	public ServerControl() {
		start();
	}

	public static void main(String[] args) {
		ServerControl serverControl = new ServerControl();
	}

	@Override
	public void start() {
		Socket socket = null;
		OutputStream outputStream = null;
		try {
			setServerSocket(new ServerSocket(getSocket()));
			while (true) {
				System.out.println("유저 대기중");
				socket = getServerSocket().accept();
				
				ReceiveThread(socket);

			}
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			if (getServerSocket() != null) {
				try {
					getServerSocket().close();
					System.out.println("서버종료");
				} catch (IOException e) {
					e.printStackTrace();
					System.out.println("서버에러");
				}
			}
		}
	}

	@Override
	public void ReceiveThread(Socket socket) {
		new Thread(new Runnable() {

			@Override
			public void run() {
//				PrintWriter out = null;
//				BufferedReader in = null;
				OutputStream outputStream = null;
				InputStream inputStream = null;
//				DataInputStream dataInputStream = null;
//				DataOutputStream dataOutputStream= null;
				ObjectInputStream player_In_Data = null;
				ObjectOutputStream player_Out_Data = null;
				Object sendObject = null;
				try {
					inputStream = socket.getInputStream();
					outputStream = socket.getOutputStream();
//					out = new PrintWriter(outputStream);
//					in = new BufferedReader(new InputStreamReader(inputStream));
					player_In_Data = new ObjectInputStream(inputStream);
					player_Out_Data = new ObjectOutputStream(outputStream);
//					dataOutputStream = new DataOutputStream(outputStream);
//					dataInputStream = new DataInputStream(inputStream);
					getDataSendList().add(player_Out_Data);
					
				} catch (IOException e) {
					System.out.println("데이터 가져오기 실패");
					e.printStackTrace();
				}

				try {
					
					while (true) {
						
						System.out.println("전송중");
						sendObject = "som";
						player_Out_Data.writeObject(sendObject);
						player_Out_Data.flush();
//						sendData(player_In_Data, player_Out_Data);
					}
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				} finally {
					try {
						socket.close();
						System.out.println(player_Out_Data + "연결 종료");
					} catch (IOException e) {
						e.printStackTrace();
					}
				}

			}
		}).start();
	}

	@Override
	public void sendData(ObjectInputStream objectInputStream, ObjectOutputStream objectOutputStream) {
		for (ObjectOutputStream send : getDataSendList()) {
			if (!send.equals(objectOutputStream)) {
				try {
					send.writeObject(objectInputStream);
					send.flush();
				} catch (IOException e) {
					e.printStackTrace();
				}

			}
		}
	}
}
